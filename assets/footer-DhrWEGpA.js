(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&o(n)}).observe(document,{childList:!0,subtree:!0});function r(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=r(s);fetch(s.href,i)}})();function q(e=".nav-menu__link",t="active"){const r=s=>s?"/"+s.replace(/^\/+|\/+$/g,""):"/",o=r(window.location.pathname);document.querySelectorAll(e).forEach(s=>{const i=s.getAttribute("href");if(!i||i.startsWith("#"))return;r(i)===o?(s.classList.add(t),s.style.pointerEvents="none",s.style.cursor="default",s.setAttribute("aria-disabled","true")):(s.classList.remove(t),s.style.pointerEvents="",s.style.cursor="",s.removeAttribute("aria-disabled"))})}const l="";class T{getAllProducts=async(t={})=>{const{flavor:r=[],weight:o=[],sort:s=null}=t;let i=l.from("products").select(`
        *,
        product_images (*),
        product_flavors!inner (
          flavor_id,
          flavors!inner (*)
        ),
        packaging_types (*),
        product_statuses (*)
      `).limit(6);r.length>0&&(i=i.in("product_flavors.flavors.value",r)),o.length>0&&(i=i.in("weight",o)),(s==="asc"||s==="desc")&&(i=i.order("price",{ascending:s==="asc"}));const{data:n,error:c}=await i;return c?(console.error("Ошибка при получении продуктов:",c.message),[]):n};getProductById=async t=>{if(!t||isNaN(t))return null;const{data:r,error:o}=await l.from("products").select(`
        *,
        product_images (
          id,
          image_path_png,
          image_path_webp,
          is_main,
          sort_order
        ),
        product_flavors (
          flavor_id,
          flavors (
            id,
            name,
            value
          )
        ),
        packaging_types (
          id,
          name
        ),
        product_statuses (
          id,
          name
        )
      `).eq("id",t).single();return o?(o.code==="PGRST116"||console.error("Ошибка при получении продукта:",o),null):r};getProductsByIds=async(t=[])=>{if(!Array.isArray(t)||t.length===0)return[];const{data:r,error:o}=await l.from("products").select(`
        *,
        product_images (*),
        product_flavors!inner (
          flavor_id,
          flavors!inner (*)
        ),
        packaging_types (*),
        product_statuses (*)
      `).in("id",t);return o?(console.error("Ошибка при получении продуктов по ID:",o.message),[]):r}}const x=new T,d={IDLE:"idle",LOADING:"loading",SUCCEEDED:"succeeded",FAILED:"failed"},b={items:[],status:d.IDLE,error:null,lastFetched:null,cachedProducts:[],cachedStatus:"idle",cachedError:null},z={name:"products",initialState:b,reducers:{setLoading:e=>({...e,status:d.LOADING,error:null}),setProducts:(e,t)=>({...e,items:t.payload,status:d.SUCCEEDED,error:null,lastFetched:new Date().toISOString()}),setError:(e,t)=>({...e,status:d.FAILED,error:t.payload}),clearError:e=>({...e,error:null}),reset:()=>b,setCachedLoading:e=>({...e,cachedStatus:d.LOADING,cachedError:null}),setCachedProducts:(e,t)=>({...e,cachedProducts:t.payload,cachedStatus:d.SUCCEEDED,cachedError:null}),setCachedError:(e,t)=>({...e,cachedStatus:d.FAILED,cachedError:t.payload})}};async function J(e){if(a.getState().products.status!==d.LOADING){a.dispatch({type:"products/setLoading"});try{const r={...e,weight:e?.weight?.map(s=>Number(s))||[]},o=await x.getAllProducts(r);return a.dispatch({type:"products/setProducts",payload:o}),o}catch(r){const o=r.message||"Unknown error occurred";throw a.dispatch({type:"products/setError",payload:o}),r}}}const N={name:"productFilters",initialState:{filters:{weight:[],flavor:[],sort:null},isInitialized:!1},reducers:{setFilters:(e,t)=>({...e,filters:{...e.filters,...t.payload}}),setInitialized:(e,t)=>({...e,isInitialized:t.payload}),resetFilters:e=>({...e,filters:{weight:[],flavor:[],sort:null}})}},j={setFilters:e=>({type:"productFilters/setFilters",payload:e}),setInitialized:e=>({type:"productFilters/setInitialized",payload:e}),resetFilters:()=>({type:"productFilters/resetFilters"})},L={IDLE:"idle",LOADING:"loading",SUCCEEDED:"succeeded",FAILED:"failed"},D={item:null,status:L.IDLE,error:null,lastFetched:null,currentId:null},G={name:"product",initialState:D,reducers:{setLoading:e=>({...e,status:L.LOADING,error:null}),setProduct:(e,t)=>({...e,item:t.payload,status:L.SUCCEEDED,error:null,lastFetched:new Date().toISOString(),currentId:t.payload?.id||null}),setError:(e,t)=>({...e,status:L.FAILED,error:t.payload,item:null}),clearError:e=>({...e,error:null}),reset:()=>D}};class M{onAuthChange(t){const{data:r}=l.auth.onAuthStateChange((o,s)=>{t(o,s)});return()=>{r.subscription.unsubscribe()}}async login({email:t,password:r}){const{data:o,error:s}=await l.auth.signInWithPassword({email:t,password:r});if(s)throw s;return o}async logout(){const{error:t}=await l.auth.signOut();if(t)throw t;return!0}async registerUser(t){const{email:r,password:o,full_name:s,phone:i,person_type:n,upload_file:c,country:f,region:S,city:E,address:g}=t,{data:h,error:I}=await l.auth.signUp({email:r,password:o});if(I)throw console.error("Ошибка регистрации в Auth:",I.message),I;const p=h.user.id;let A=null;if(c&&c.name){const y=c.name.split(".").pop(),u=`${p}.${y}`,{error:_}=await l.storage.from("avatars").upload(u,c,{cacheControl:"no-cache",upsert:!0});_&&console.warn("Предупреждение: Ошибка загрузки аватара, продолжение регистрации:",_.message);const{data:U}=l.storage.from("avatars").getPublicUrl(u);A=U.publicUrl}const O={id:p,full_name:s,phone:i,country:f||null,region:S||null,city:E||null,address:g||null,person_type:n,avatar_url:A},{error:v}=await l.from("profiles").insert([O]);if(v)throw console.error("Ошибка вставки в profiles:",v.message),v;if(n==="fop"&&t.fop){const y={profile_id:p,edrpou:t.fop.edrpou,country:t.fop.country||null,region:t.fop.region||null,city:t.fop.city||null,address:t.fop.address||null},{error:u}=await l.from("fop_details").insert([y]);if(u)throw console.error("Ошибка вставки в fop_details:",u.message),u}else if(n==="legal"&&t.legal_entity){const y={profile_id:p,okpo:t.legal_entity.okpo,country:t.legal_entity.country||null,region:t.legal_entity.region||null,city:t.legal_entity.city||null,address:t.legal_entity.address||null,postal_code:t.legal_entity.postal_code||null},{error:u}=await l.from("legal_entity_details").insert([y]);if(u)throw console.error("Ошибка вставки в legal_entity_details:",u.message),u}return h}}const C=new M,m={IDLE:"idle",LOADING:"loading",SUCCEEDED:"succeeded",FAILED:"failed"},P={user:null,session:null,isAuth:!1,status:m.IDLE,error:null},$={name:"auth",initialState:P,reducers:{setLoading:(e,t)=>({...e,status:m.LOADING,error:null}),setAuth:(e,t)=>({...e,status:m.SUCCEEDED,error:null,user:t.payload.user,session:t.payload.session,isAuth:!!t.payload.session}),setError:(e,t)=>({...e,status:m.FAILED,error:t.payload,user:null,session:null,isAuth:!1}),clearError:e=>({...e,error:null}),resetAuth:()=>P}};async function V(e){if(a.getState().auth.status!==m.LOADING){a.dispatch({type:"auth/setLoading"});try{const r=await C.registerUser(e);return a.dispatch({type:"auth/setAuth",payload:{user:r.user,session:r.session}}),r}catch(r){const o=r.message||"Не удалось завершить регистрацию";throw a.dispatch({type:"auth/setError",payload:o}),r}}}async function X(e,t){a.dispatch({type:"auth/setLoading"});try{const r=await C.login({email:e,password:t});return a.dispatch({type:"auth/setAuth",payload:{user:r.user,session:r.session}}),r}catch(r){throw a.dispatch({type:"auth/setError",payload:r.message}),r}}const R={IDLE:"idle"},F={items:[],status:R.IDLE,error:null,products:[],isProductsLoading:!1,productsError:null},H={name:"cart",initialState:F,reducers:{addItem:(e,t)=>{const r=String(t.payload.productId);return e.items.find(s=>s.productId===r)?{...e,items:e.items.map(s=>s.productId===r?{...s,quantity:s.quantity+1}:s)}:{...e,items:[...e.items,{productId:r,quantity:1}]}},removeItem:(e,t)=>{const r=String(t.payload.productId);return{...e,items:e.items.filter(o=>o.productId!==r),products:e.products.filter(o=>String(o.id)!==r)}},incrementQuantity:(e,t)=>{const r=t.payload.productId;return e.items.find(s=>s.productId===r)?{...e,items:e.items.map(s=>s.productId===r?{...s,quantity:s.quantity+1}:s)}:{...e,items:[...e.items,{productId:r,quantity:1}]}},decrementQuantity:(e,t)=>{const r=t.payload.productId,o=e.items.find(s=>s.productId===r);return o?o.quantity<=1?{...e,items:e.items.filter(s=>s.productId!==r)}:{...e,items:e.items.map(s=>s.productId===r?{...s,quantity:s.quantity-1}:s)}:e},setQuantity:(e,t)=>{const{productId:r,quantity:o}=t.payload;return o<=0?{...e,items:e.items.filter(i=>i.productId!==r)}:e.items.find(i=>i.productId===r)?{...e,items:e.items.map(i=>i.productId===r?{...i,quantity:o}:i)}:{...e,items:[...e.items,{productId:r,quantity:o}]}},clearCart:()=>F,setCartProductsLoading:e=>({...e,isProductsLoading:!0,productsError:null}),setCartProducts:(e,t)=>({...e,products:t.payload,isProductsLoading:!1,productsError:null}),setCartProductsError:(e,t)=>({...e,isProductsLoading:!1,productsError:t.payload})}};class B{constructor(){this.state={},this.reducers={},this.listeners=new Map,this.persistConfig={},this.storageKey="app_store"}registerSlice(t,r={persist:!1,fields:null}){const s=this.loadFullStoreFromStorage()[t.name],i=s?{...t.initialState,...s}:t.initialState;this.state[t.name]=i,this.reducers[t.name]=t.reducers,this.persistConfig[t.name]=r}getState(){return this.state}dispatch(t){const[r,o]=t.type.split("/");if(!r||!o){console.error(`Некорректный action.type: ${t.type}. Ожидается 'slice/reducer'.`);return}const s=this.reducers[r];if(!s||!s[o]){console.warn(`Не найден редьюсер ${o} в слайсе ${r}.`);return}const i=s[o],n=this.state[r],c=i(n,t);this.state[r]=c,this.saveSliceToFullStorage(r,c),this.notify(r,c)}subscribe(t,r){this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(r);const o=this.state[t];o!==void 0&&r(o)}unsubscribe(t,r){this.listeners.has(t)&&(this.listeners.get(t).delete(r),this.listeners.get(t).size===0&&this.listeners.delete(t))}notify(t,r){this.listeners.has(t)&&this.listeners.get(t).forEach(o=>{o(r)})}loadFullStoreFromStorage(){const t=localStorage.getItem(this.storageKey);if(!t)return{};try{return JSON.parse(t)}catch{return{}}}saveSliceToFullStorage(t,r){const o=this.persistConfig[t];if(!o?.persist)return;const s=this.loadFullStoreFromStorage();let i=r;Array.isArray(o.fields)&&(i={},o.fields.forEach(n=>{r.hasOwnProperty(n)&&(i[n]=r[n])})),s[t]=i,localStorage.setItem(this.storageKey,JSON.stringify(s))}}const a=new B;a.registerSlice($);a.registerSlice(H,{persist:!0,fields:["items"]});a.registerSlice(z);a.registerSlice(N);a.registerSlice(G);const Y="/nuts/";async function Z(){k(),K(),q(".nav-menu__link"),Q()}function k(){const e=document.querySelector(".header__burger-btn"),t=document.querySelector(".mobile-menu");if(!e||!t)return;e.addEventListener("click",function(){const o=t.classList.toggle("is-open");e.setAttribute("aria-expanded",o?"true":"false"),document.body.style.overflow=o?"hidden":"auto"}),document.addEventListener("click",o=>{const s=t.contains(o.target),i=e.contains(o.target);!s&&!i&&t.classList.contains("is-open")&&r()}),document.addEventListener("keydown",o=>{o.key==="Escape"&&t.classList.contains("is-open")&&r()});function r(){t.classList.remove("is-open"),e.setAttribute("aria-expanded","false"),document.body.style.overflow="auto"}}function K(){const e=document.querySelector(".mobile-menu"),t=document.querySelector(".header__burger-btn");!e||!t||window.addEventListener("resize",function(){e.classList.contains("is-open")&&(e.classList.remove("is-open"),t.setAttribute("aria-expanded","false"),document.body.style.overflow="auto")})}function Q(e=".header"){const t=document.querySelector(e);if(!t)return null;const r=document.documentElement,o=new ResizeObserver(s=>{const i=s[0].target.offsetHeight;r.style.setProperty("--header-height",`${i}px`)});return o.observe(t),o}function tt(e=".lazy",t={}){const o={...{root:null,rootMargin:"0px",threshold:.01},...t},s=document.querySelectorAll(e);if("IntersectionObserver"in window){let i=s.length;const n=(f,S)=>{f.forEach(E=>{if(E.isIntersecting){const g=E.target;w(g,e);const h=g.closest("picture");h&&h.querySelectorAll("source[data-srcset]").forEach(p=>w(p,e)),S.unobserve(g),i--,i===0&&S.disconnect()}})},c=new IntersectionObserver(n,o);s.forEach(f=>{c.observe(f)})}else s.forEach(i=>w(i,e))}function w(e,t){const r=e.tagName.toLowerCase()==="iframe",o="/nuts/";e.dataset.src&&(e.src=r?e.dataset.src:o+e.dataset.src.replace(/^\/+/,""),delete e.dataset.src),e.dataset.srcset&&(e.srcset=r?e.dataset.srcset:o+e.dataset.srcset.replace(/^\/+/,""),delete e.dataset.srcset),e.classList.contains(t.replace(".",""))&&e.classList.remove(t.replace(".",""))}const et=()=>{W()},W=(e=".js-accordion-title",t=".page-footer-item",r=500)=>{const o=document.querySelectorAll(e);o.length&&o.forEach(s=>{s.addEventListener("click",()=>{if(window.innerWidth<=r){const i=s.closest(t),n=i.classList.contains("is-active");document.querySelectorAll(t).forEach(c=>{c.classList.remove("is-active")}),n||i.classList.add("is-active")}})})};export{m as A,d as P,et as a,Y as b,l as c,X as d,J as f,Z as i,tt as l,j as p,V as r,a as s};
